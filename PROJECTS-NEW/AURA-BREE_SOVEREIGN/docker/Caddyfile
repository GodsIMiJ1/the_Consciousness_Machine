# Sovereign AURA-BREE Caddy Configuration
# Reverse proxy with mTLS support for clinic integration

{
    # Global options
    admin off
    auto_https off
}

# Main application (AURA-BREE mobile app)
{$DOMAIN:localhost} {
    # Serve static files for mobile app
    root * /srv
    file_server

    # API routes to FlameRouter
    handle /api/* {
        reverse_proxy flame-router:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Health check endpoint
    handle /health {
        reverse_proxy flame-router:3000
    }

    # Ollama API (local AI)
    handle /ollama/* {
        uri strip_prefix /ollama
        reverse_proxy ollama:11434 {
            header_up Host {host}
            header_up X-Real-IP {remote}
        }
    }

    # WebSocket support for real-time features
    handle /ws/* {
        reverse_proxy flame-router:3000 {
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
        }
    }

    # Security headers
    header {
        # HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # Content Security Policy
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' ws: wss:; font-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self';"
        
        # Other security headers
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # Remove server info
        -Server
    }

    # Logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }
}

# Clinic Dashboard (MethaClinic integration)
{$CLINIC_DOMAIN:clinic.local} {
    # Clinic dashboard
    reverse_proxy clinic-dashboard:3000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
    }

    # mTLS for clinic authentication (production)
    @clinic_api path /api/clinic/*
    handle @clinic_api {
        # Client certificate verification
        tls {
            client_auth {
                mode require_and_verify
                trusted_ca_cert_file /etc/caddy/certs/clinic-ca.pem
            }
        }
        
        reverse_proxy flame-router:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Client-Cert {tls_client_certificate}
            header_up X-Client-Cert-Subject {tls_client_subject}
        }
    }

    # Enhanced security for clinic
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; font-src 'self'; object-src 'none';"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        -Server
    }

    # Clinic-specific logging
    log {
        output file /var/log/caddy/clinic.log {
            roll_size 100mb
            roll_keep 10
            roll_keep_for 2160h  # 90 days
        }
        format json
    }
}

# Monitoring endpoints (internal only)
:9090 {
    # Prometheus metrics
    reverse_proxy prometheus:9090

    # Restrict to internal network
    @internal remote_ip 172.20.0.0/16 127.0.0.1/8
    handle @internal {
        reverse_proxy prometheus:9090
    }
    
    handle {
        respond "Access Denied" 403
    }
}

:3002 {
    # Grafana dashboards
    @internal remote_ip 172.20.0.0/16 127.0.0.1/8
    handle @internal {
        reverse_proxy grafana:3000
    }
    
    handle {
        respond "Access Denied" 403
    }
}

# Development endpoints (only in dev mode)
:8080 {
    # Direct access to services for development
    handle /ollama/* {
        uri strip_prefix /ollama
        reverse_proxy ollama:11434
    }
    
    handle /api/* {
        reverse_proxy flame-router:3000
    }
    
    handle /db/* {
        uri strip_prefix /db
        reverse_proxy supabase-rest:3000
    }
    
    handle {
        respond "Sovereign AURA-BREE Development Gateway" 200
    }
}
